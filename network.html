<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis: Power Structures | APL v4.3</title>
    
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/favicon.svg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Custom Tailwind Configuration to match investigations.html -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Open Sans', 'sans-serif'],
                        serif: ['Lora', 'serif'],
                    },
                }
            }
        }
    </script>

    <style>
        /* Core style alignment with investigations.html */
        body { font-family: 'Open Sans', sans-serif; background-color: #F9F6F2; color: #1f2937; }
        .nav-link { color: #4b5563; transition: color 0.2s; padding-bottom: 0.25rem; font-family: 'Open Sans', sans-serif; }
        .nav-link:hover { color: #B91C1C; }
        .nav-link.active { color: #111827; font-weight: 700; border-bottom: 2px solid #B91C1C; }
        
        /* Main layout and panel styling */
        .main-grid { display: grid; grid-template-columns: 1fr 400px; gap: 1.5rem; align-items: flex-start; }
        #network-container { height: 85vh; border-radius: 0.5rem; background-color: #ffffff; border: 1px solid #d1d5db; }
        #analysis-panel { height: 85vh; background-color: #fff; border: 1px solid #d1d5db; border-radius: 0.5rem; display: flex; flex-direction: column; }
        #analysis-panel-content { padding: 1.5rem; overflow-y: auto; }
        
        /* Control and filter styling */
        .control-panel { background-color: #fff; border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; }
        .filter-btn {
            background-color: #fff; border: 1px solid #d1d5db; color: #374151;
            padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .filter-btn:hover { background-color: #f9fafb; border-color: #9ca3af; }
        .filter-btn.active { background-color: #B91C1C; color: white; border-color: #B91C1C; }

        /* Dossier content styling within the side panel */
        .dossier h1, .dossier h2, .dossier h3 { font-family: 'Lora', serif; font-weight: 700; color: #111827; }
        .dossier h1 { font-size: 1.5rem; margin-bottom: 0.5rem;}
        .dossier h2 { font-size: 1.25rem; border-top: 1px solid #e5e7eb; padding-top: 1.5rem; margin-top: 1.5rem; margin-bottom: 1rem;}
        .dossier h3 { font-size: 1.1rem; margin-bottom: 0.75rem; }
        .dossier p { margin-bottom: 1rem; color: #374151; line-height: 1.6; }
        .dossier strong { color: #1f2937; }
        .dossier .apl-link { color: #B91C1C; text-decoration: underline; text-underline-offset: 2px; font-weight: 600; }
        .dossier .text-sm.font-semibold { font-size: 0.875rem; color: #B91C1C; text-transform: uppercase; }
        .dossier blockquote { border-left-color: #d1d5db; }
        
        /* Vis.js UI customization */
        .vis-navigation .vis-button { background-color: #fff; border: 1px solid #d1d5db; color: #374151; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .vis-navigation .vis-button:hover { background-color: #f9fafb; }
        
    </style>
</head>
<body class="antialiased min-h-screen">
    <!-- Updated Nav to match investigations.html -->
    <nav class="container mx-auto max-w-screen-2xl px-4 sm:px-6 lg:px-8 py-4 mb-8">
        <div class="flex justify-between items-center">
            <a href="index.html" class="font-bold text-2xl tracking-tight text-gray-900 font-serif">APL</a>
            <div class="space-x-6">
                <a href="index.html" class="nav-link">Home</a>
                <a href="investigations.html" class="nav-link">Investigations</a>
                <a href="network.html" class="nav-link active">Network Analysis</a>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto max-w-screen-2xl px-4 sm:px-6 lg:px-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold tracking-tight text-gray-900 font-serif">Network of Complicity</h1>
            <p class="mt-4 max-w-3xl mx-auto text-lg text-gray-700">
                A strategic analysis of the power structures connecting state, corporate, financial, and ideological actors in support of Israeli apartheid.
            </p>
        </header>

        <div class="control-panel">
            <h3 class="font-bold text-gray-900 mb-3 font-serif">Analysis Filters</h3>
            <div class="flex flex-wrap gap-3">
                <button class="filter-btn active" data-group="all">All Sectors</button>
                <button class="filter-btn" data-group="0">State Actors</button>
                <button class="filter-btn" data-group="1">Corporate Power</button>
                <button class="filter-btn" data-group="2">Financial & Pension</button>
                <button class="filter-btn" data-group="3">Ideological Apparatus</button>
                <button class="filter-btn" data-group="4">Resistance Networks</button>
            </div>
        </div>

        <div class="main-grid">
            <section id="network-container">
                <div id="complicity-map" class="w-full h-full"></div>
            </section>
            
            <aside id="analysis-panel">
                <div id="analysis-panel-content" class="dossier">
                     <h3 class="text-gray-400 font-serif">Analysis Panel</h3>
                    <p class="text-gray-500">Select a node from the network graph to view its detailed dossier and analyze its connections.</p>
                </div>
            </aside>
        </div>
    </main>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('complicity-map');
            const analysisPanelContent = document.getElementById('analysis-panel-content');
            const filterButtons = document.querySelectorAll('.filter-btn');

            // --- DATASET V4.3 ---
            // Added 'dossierFile' property for live synthesis
            const rawNodes = [
                {id: 1, label: 'S.H.\nSanders', group: 0, dossierFile: 'investigation-state-apparatus.html'},
                {id: 2, label: 'Tom\nCotton', group: 0, dossierFile: 'investigation-propaganda-pipeline.html'},
                {id: 4, label: 'AR\nAssembly', group: 0, dossierFile: 'investigation-state-apparatus.html'},
                {id: 7, label: 'AEDC', group: 0, details: "<h3>AR Economic Development Commission</h3><p>A quasi-governmental entity that provides subsidies, tax breaks, and incentives to corporations, particularly defense contractors like Lockheed Martin, to operate in Arkansas.</p>"},
                {id: 10, label: 'Walmart', group: 1, dossierFile: 'investigation-corporate-nexus.html'},
                {id: 12, label: 'Stephens\nInc.', group: 1, dossierFile: 'investigation-corporate-nexus.html'},
                {id: 13, label: 'Lockheed\nMartin', group: 1, dossierFile: 'investigation-military-police-nexus.html'},
                {id: 20, label: 'ATRS', group: 2, dossierFile: 'investigation-atrs-bonds.html'},
                {id: 22, label: 'BlackRock', group: 2, details: "<h3>BlackRock</h3><p>One of the world's largest asset managers. Manages a significant portion of ATRS funds and is a top institutional holder of major defense contractors like RTX and Lockheed Martin.</p>"},
                {id: 30, label: 'AIPAC', group: 3, dossierFile: 'investigation-propaganda-pipeline.html'},
                {id: 40, label: 'AR Lib.\nCollective', group: 4, details: "<h3>Arkansas Liberation Collective</h3><p>A grassroots organization engaged in direct action, political education, and counter-protests against complicit institutions.</p>"}
            ];
            const rawEdges = [
                {from: 4, to: 10, type: 'political'}, {from: 7, to: 13, type: 'financial'}, 
                {from: 1, to: 4, type: 'political'}, {from: 20, to: 22, type: 'financial'}, 
                {from: 22, to: 13, type: 'financial'}, {from: 12, to: 2, type: 'financial'}, 
                {from: 30, to: 2, type: 'ideological'}, {from: 30, to: 1, type: 'ideological'},
                {from: 40, to: 30, type: 'resistance'}, {from: 40, to: 4, type: 'resistance'}
            ];

            // --- DATA ENRICHMENT ---
            const connectionCount = {};
            rawEdges.forEach(e => { connectionCount[e.from] = (connectionCount[e.from] || 0) + 1; connectionCount[e.to] = (connectionCount[e.to] || 0) + 1; });
            const groupNames = { 0: 'State Actor', 1: 'Corporate Power', 2: 'Financial/Pension', 3: 'Ideological Apparatus', 4: 'Resistance Network' };
            const edgeColors = { political: '#3b82f6', financial: '#16a34a', ideological: '#8b5cf6', resistance: '#ef4444' };

            const nodesWithData = rawNodes.map(n => {
                const conns = connectionCount[n.id] || 0;
                n.value = conns;
                const tooltipElement = document.createElement('div');
                tooltipElement.style.padding = '8px';
                tooltipElement.style.fontFamily = 'Open Sans, sans-serif';
                tooltipElement.innerHTML = `<h4 style="font-family: 'Lora', serif; font-weight: 700; font-size: 1rem; margin: 0 0 4px 0;">${n.label.replace(/\\n/g,' ')}</h4><p style="margin: 0 0 4px 0; color: #6b7280;">${groupNames[n.group]}</p><p style="margin: 0;">Connections: <strong>${conns}</strong></p>`;
                n.title = tooltipElement;
                return n;
            });

            const edgesWithColors = rawEdges.map(e => { e.color = edgeColors[e.type] || '#9ca3af'; return e; });
            const nodes = new vis.DataSet(nodesWithData);
            const edges = new vis.DataSet(edgesWithColors);

            // --- VIS.JS OPTIONS ---
            const options = {
                nodes: {
                    shape: 'dot',
                    scaling: { min: 20, max: 50 },
                    font: { size: 14, face: 'Open Sans', color: '#1f2937', multi: true, strokeWidth: 4, strokeColor: 'rgba(255,255,255,0.8)' },
                    borderWidth: 2,
                },
                edges: {
                    width: 2,
                    arrows: { to: { enabled: true, scaleFactor: 0.6 } },
                    smooth: { type: 'continuous' }
                },
                groups: {
                    0: { color: { border: '#991b1b', background: '#fecaca' }, font: { color: '#991b1b' } },
                    1: { color: { border: '#1d4ed8', background: '#dbeafe' }, font: { color: '#1e40af' } },
                    2: { color: { border: '#15803d', background: '#d1fae5' }, font: { color: '#14532d' } },
                    3: { color: { border: '#5b21b6', background: '#ede9fe' }, font: { color: '#4c1d95' } },
                    4: { color: { border: '#b45309', background: '#fef3c7' }, font: { color: '#78350f' } },
                },
                physics: {
                    barnesHut: { gravitationalConstant: -60000, centralGravity: 0.2, springLength: 250, damping: 0.3 },
                    solver: 'barnesHut',
                },
                interaction: { navigationButtons: true, keyboard: true, hover: true, tooltipDelay: 100 },
            };
            const network = new vis.Network(container, { nodes, edges }, options);

            // --- INTERACTION LOGIC (WITH LIVE SYNTHESIS) ---
            let activeNodeId = null;

            const selectNode = async (nodeId) => {
                // Deselect previous node
                if (activeNodeId) { nodes.update({ id: activeNodeId, borderWidth: 2, shadow: false }); }
                activeNodeId = nodeId;
                const nodeData = nodes.get(nodeId);
                
                // Highlight new node
                nodes.update({ id: nodeId, borderWidth: 4, shadow: { enabled: true, color: 'rgba(185, 28, 28, 0.5)', size: 20, x: 0, y: 0 } });
                network.focus(nodeId, { scale: 1.2, animation: { duration: 500, easingFunction: 'easeInOutQuad' } });
                
                // Set loading state in panel
                analysisPanelContent.innerHTML = `<h3 class="font-serif">Accessing Dossier...</h3><p class="text-gray-500">Synthesizing intelligence for ${nodeData.label.replace('\\n', ' ')}.</p>`;

                if (nodeData.dossierFile) {
                    try {
                        const response = await fetch(nodeData.dossierFile);
                        if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                        const htmlText = await response.text();
                        
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(htmlText, 'text/html');
                        
                        // Extract header and sections for synthesis
                        const header = doc.querySelector('header.mb-16');
                        const sections = doc.querySelectorAll('section.mb-16');
                        
                        let synthesizedHTML = header ? header.innerHTML : '';
                        sections.forEach(section => {
                            synthesizedHTML += section.innerHTML;
                        });

                        analysisPanelContent.innerHTML = synthesizedHTML || 'Could not parse dossier content.';

                    } catch (error) {
                        console.error('Failed to fetch or parse dossier:', error);
                        analysisPanelContent.innerHTML = `<h3>Error</h3><p>Could not load dossier for ${nodeData.label.replace('\\n', ' ')}. File not found or connection issue.</p>`;
                    }
                } else {
                    // Fallback for nodes without a dossier file
                    analysisPanelContent.innerHTML = nodeData.details || `<h3>No Detailed Dossier</h3><p>Intelligence for this node is pending.</p>`;
                }
            };

            network.on('click', p => p.nodes.length > 0 && selectNode(p.nodes[0]));
            
            filterButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    const group = e.target.dataset.group;
                    const view = new vis.DataView(nodes, { filter: item => group === 'all' || item.group == group });
                    network.setData({ nodes: view, edges: edges });
                });
            });
        });
    </script>
</body>
</html>
